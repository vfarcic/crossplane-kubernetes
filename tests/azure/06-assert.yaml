---
apiVersion: devopstoolkitseries.com/v2
kind: Cluster
metadata:
  namespace: ($namespace)
spec:
  crossplane:
    compositionRef:
      name: cluster-azure
    compositionSelector:
      matchLabels:
        cluster: aks
        provider: azure
    compositionUpdatePolicy: Automatic
    resourceRefs:
    - apiVersion: azure.m.upbound.io/v1beta1
      kind: ResourceGroup
      name: a-team-aks
    - apiVersion: containerservice.azure.m.upbound.io/v1beta1
      kind: KubernetesCluster
      name: a-team-aks
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: ProviderConfig
      name: a-team-aks
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name:  a-team-aks-app-crossplane
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name: a-team-aks-app-dapr
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name:  a-team-aks-app-external-secrets
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name:  a-team-aks-app-openfunction
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name: a-team-aks-cilium
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-aks-creds
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-aks-ns-dev
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-aks-ns-production
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-aks-secret-push-secret
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-aks-secret-store
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: ProviderConfig
      name: a-team-aks
  id: a-team-aks
  parameters:
    minNodeCount: 1
    nodeSize: medium
    apps:
      crossplane:
        enabled: true
      openfunction:
        enabled: true
      externalSecrets:
        enabled: true
        store: true
        azureVaultUrl: https://dot.vault.azure.net
        secrets:
          - fromSecret: registry-auth
            toSecret: push-secret
            toNamespace: production
      dapr:
        enabled: true
    creds:
      name: azure-creds
      namespace: crossplane-system
      keys:
        - creds
        - vaultUrl
---
apiVersion: helm.m.crossplane.io/v1beta1
kind: Release
metadata:
  annotations:
    crossplane.io/composition-resource-name: a-team-aks-app-dapr
    crossplane.io/external-name: dapr
  labels:
    crossplane.io/composite: a-team-aks
  name: a-team-aks-app-dapr
  ownerReferences:
  - apiVersion: devopstoolkitseries.com/v2
    blockOwnerDeletion: true
    controller: true
    kind: Cluster
spec:
  forProvider:
    chart:
      name: dapr
      repository: https://dapr.github.io/helm-charts/
      version: 1.16.8
    namespace: dapr-system
  providerConfigRef:
    kind: ProviderConfig
    name: a-team-aks
  rollbackLimit: 3
