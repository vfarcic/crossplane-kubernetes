---
apiVersion: devopstoolkitseries.com/v2
kind: Cluster
metadata:
  name: (join('-', ['a-team', $cluster]))
  namespace: ($namespace)
spec:
  parameters:
    apps:
      argocd:
        enabled: true
  (crossplane.resourceRefs[?name == join('-', ['a-team', $cluster, 'app-argo-cd'])]):
  - apiVersion: helm.m.crossplane.io/v1beta1
    kind: Release
  (crossplane.resourceRefs[?name == join('-', ['a-team', $cluster, 'app-argo-cd-app'])]):
  - apiVersion: kubernetes.m.crossplane.io/v1alpha1
    kind: Object
---
apiVersion: helm.m.crossplane.io/v1beta1
kind: Release
metadata:
  annotations:
    crossplane.io/composition-resource-name: (join('-', ['a-team', $cluster, 'app-argo-cd']))
    crossplane.io/external-name: argo-cd
  name: (join('-', ['a-team', $cluster, 'app-argo-cd']))
  ownerReferences:
  - apiVersion: devopstoolkitseries.com/v2
    blockOwnerDeletion: true
    controller: true
    kind: Cluster
spec:
  forProvider:
    chart:
      name: argo-cd
      repository: https://argoproj.github.io/argo-helm
      version: 3.35.4
    values:
      global:
        domain: argocd.acme.com
      configs:
        secret:
          argocdServerAdminPassword: "$2a$10$m3eTlEdRen0nS86c5Zph5u/bDFQMcWZYdG3NVdiyaACCqoxLJaz16"
          argocdServerAdminPasswordMtime: "2021-11-08T15:04:05Z"
        cm:
          application.resourceTrackingMethod: annotation
          timeout.reconciliation: 60s
        params:
          "server.insecure": true
      server:
        ingress:
          enabled: true
          ingressClassName: traefik
        extraArgs:
        - --insecure
    namespace: argocd
  providerConfigRef:
    kind: ProviderConfig
    name: (join('-', ['a-team', $cluster]))
---
apiVersion: kubernetes.m.crossplane.io/v1alpha1
kind: Object
metadata:
  annotations:
    crossplane.io/composition-resource-name: (join('-', ['a-team', $cluster, 'app-argo-cd-app']))
    crossplane.io/external-name: argo-cd-app
  name: (join('-', ['a-team', $cluster, 'app-argo-cd-app']))
spec:
  forProvider:
    manifest:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: apps
        namespace: argocd
        finalizers:
          - resources-finalizer.argocd.argoproj.io
      spec:
        project: default
        source:
          repoURL: https://github.com/vfarcic/my-repo
          targetRevision: HEAD
          path: my-path
        destination:
          server: https://kubernetes.default.svc
          namespace: my-namespace
        syncPolicy:
          automated:
            selfHeal: true
            prune: true
            allowEmpty: true
  providerConfigRef:
    kind: ProviderConfig
    name: (join('-', ['a-team', $cluster]))
