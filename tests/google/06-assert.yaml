apiVersion: devopstoolkit.ai/v2
kind: Cluster
metadata:
  namespace: ($namespace)
spec:
  crossplane:
    compositionRef:
      name: cluster-google
    compositionSelector:
      matchLabels:
        cluster: gke
        provider: google
    compositionUpdatePolicy: Automatic
    resourceRefs:
    - apiVersion: container.gcp.m.upbound.io/v1beta1
      kind: Cluster
      name: a-team-gke
    - apiVersion: container.gcp.m.upbound.io/v1beta1
      kind: NodePool
      name: a-team-gke
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: ProviderConfig
      name: a-team-gke
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name:  a-team-gke-app-crossplane
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name: a-team-gke-app-dapr
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name:  a-team-gke-app-external-secrets
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name:  a-team-gke-app-openfunction
    - apiVersion: helm.m.crossplane.io/v1beta1
      kind: Release
      name: a-team-gke-cilium
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-gke-creds
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-gke-ns-dev
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-gke-ns-production
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-gke-secret-push-secret
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: Object
      name: a-team-gke-app-secret-store
    - apiVersion: kubernetes.m.crossplane.io/v1alpha1
      kind: ProviderConfig
      name: a-team-gke
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-cilium-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-creds-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-crossplane-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-dapr-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-external-secrets-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-openfunction-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-secret-push-secret-usage
    - apiVersion: protection.crossplane.io/v1beta1
      kind: Usage
      name: a-team-gke-secret-store-usage
  parameters:
    minNodeCount: 1
    nodeSize: medium
    apps:
      crossplane:
        enabled: true
      openfunction:
        enabled: true
      externalSecrets:
        enabled: true
        store: true
        googleCredentialsKey: google-creds
        secrets:
          - fromSecret: registry-auth
            toSecret: push-secret
            toNamespace: production
      dapr:
        enabled: true
    creds:
      name: gcp-creds
      namespace: crossplane-system
      keys:
        - google-creds
---
apiVersion: helm.m.crossplane.io/v1beta1
kind: Release
metadata:
  annotations:
    crossplane.io/external-name: dapr
  labels:
    crossplane.io/composite: a-team-gke
  name: a-team-gke-app-dapr
  ownerReferences:
  - apiVersion: devopstoolkit.ai/v2
    blockOwnerDeletion: true
    controller: true
    kind: Cluster
spec:
  forProvider:
    chart:
      name: dapr
      repository: https://dapr.github.io/helm-charts/
      version: 1.16.8
    namespace: dapr-system
  providerConfigRef:
    kind: ProviderConfig
    name: a-team-gke
  managementPolicies:
  - Create
  - Update
  - Observe
  rollbackLimit: 3

